<?xml version="1.0"?>
<ScatterFile xmlns="http://schemas.microsoft.com/netmf/ScatterfileSchema.xsd">

    <!-- STM32F4 with 1M Flash, 128k SRAM, and 64k DATA CCM -->

    <Set Name="Valid" Value="false"/>

    <!-- ################################################################################ -->
    <!-- Memory Region base and size values for physical hardware to help clarify the mapping
         by making Symbolic names available instead of a bunch of numbers. These values are
         fixed in hardware and therefore, don't change.
    -->
    <!-- Internal FLASH -->
    <Set Name="IFLASH_BaseAddress"      Value="0x08000000"/>
    <Set Name="IFLASH_Size"             Value="0x00100000"/><!-- 1MB -->

    <!-- Internal Core Coupled Memory (CCM) [D-Bus] -->
    <Set Name="CCM_BaseAddress"         Value="0x10000000"/>
    <Set Name="CCM_Size"                Value="0x00010000"/><!-- 64KB -->

    <!-- Internal SRAM -->
    <Set Name="IRAM_BaseAddress"        Value="0x20000000"/>
    <Set Name="IRAM_Size"               Value="0x00020000"/><!-- 128KB -->

    <!-- Solution specific usage settings -->

    <!-- Internal FLASH -->
    <!--
         The flash memory layout must match BlockRange definitions
         in DeviceCode\Blockstorage\STM32F4\STM32F4_BlConfig.cpp
    -->
    <!-- TinyBooter sits at power on Reset vector-->
    <Set Name="BooterCode_BaseAddress"  Value="%IFLASH_BaseAddress%"/>
    <Set Name="BooterCode_Size"         Value="0x0000C000"/><!-- 48KB -->

    <!-- Configuration section -->
    <Set Name="Config_BaseAddress"      Value="%BooterCode_BaseAddress% + %BooterCode_Size%"/>
    <Set Name="Config_Size"             Value="0x00004000"/><!-- 16KB -->

    <!-- Native Code section -->
    <Set Name="Code_BaseAddress"        Value="%Config_BaseAddress% + %Config_Size%"/>
    <Set Name="Code_Size"               Value="0x00080000"/><!-- 512KB -->

    <!-- Deployment fills the rest of flash... --><!-- 384KB -->

    <!-- Internal CCM (D-Bus) -->
    <!-- Put Stack in CCM for high speed access, reducing overhead of stack usage -->
    <Set Name="Stack_Bottom"            Value="%CCM_BaseAddress%"/>
    <Set Name="Stack_Size"              Value="%CCM_Size%" />

    <!-- Internal SRAM -->
    <!-- FIXME: Dynamically after RAM_RW region, properly aligned. -->
    <!--<Set Name="Heap_BaseAddress"        Value="0x20008000"/>-->
    <!--<Set Name="Heap_Size"               Value="0x00017000"/>-->  <!-- 92K -->

    <Set Name="CustomHeap_Size"         Value="0x00000000"/><!--  4K -->
   
    <GlobalVariable Name="__stack"      Value="%Stack_Bottom% + %Stack_Size%"/>
    <GlobalVariable Name="_estack"      Value="__stack"/>
    
    <FileMapping Name="__Main_Stack_Size = 1024;"/>
    <FileMapping Name="_Minimum_Stack_Size = 256;"/>

    <FileMapping Name="PROVIDE ( _Main_Stack_Size = __Main_Stack_Size ) ;"/>
    <FileMapping Name="__Main_Stack_Limit = __stack  - __Main_Stack_Size ;"/>
    <FileMapping Name="PROVIDE ( _Main_Stack_Limit = __Main_Stack_Limit ) ;"/>

   <FileMapping Name="PROVIDE ( _Heap_Begin = _end_noinit ) ;"/>
   <FileMapping Name="PROVIDE ( _Heap_Limit = %IRAM_BaseAddress% + %IRAM_Size% - 8) ;"/>

    <If Name="TARGETLOCATION" Value="FLASH">
        <Set Name="Valid"               Value="true"/>
    </If>

    <!-- ################################################################################ -->
    <If Name="Valid" Value="false">
        <Error Message="Configuration not recognized"/>
    </If>

    <EntryPoint Name="EntryPoint" />

    <NamedGroup Name="MEMORY">
        <LoadRegion Name="D_CCM" Base="%CCM_BaseAddress%" Size="%CCM_Size%" />
        <LoadRegion Name="IRAM" Base="%IRAM_BaseAddress%" Size="%IRAM_Size%" />
        <LoadRegion Name="LR_%TARGETLOCATION%" Base="%Code_BaseAddress%" Size="%Code_Size%" />
        <LoadRegion Name="LR_CONFIG" Base="%Config_BaseAddress%" Size="%Config_Size%"/>
    </NamedGroup>

    <NamedGroup Name="SECTIONS">
        <!-- ========= INTERNAL FLASH ============================================ -->
        <ExecRegion Name="ER_%TARGETLOCATION%" Options="&gt;LR_%TARGETLOCATION%">
            <FileMapping Name="*(i.EntryPoint)"/>
            <FileMapping Name="*(SectionForBootstrapOperations)"/>
            <FileMapping Name="*(SectionForFlashOperations)"/>
            
            <FileMapping Name="KEEP(*(.init))"/>
            <FileMapping Name="KEEP(*(.fini))"/>
            
            
            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="PROVIDE_HIDDEN(__preinit_array_start = . );"/>
            <FileMapping Name="KEEP(*(.preinit_array .preinit_array.*))"/>
            <FileMapping Name="PROVIDE_HIDDEN(__preinit_array_end = . );"/>

            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="PROVIDE_HIDDEN(__init_array_start = . );"/>
            <FileMapping Name="KEEP(*(SORT(.init_array)))"/>
            <FileMapping Name="KEEP(*(.init_array))"/>
            <FileMapping Name="PROVIDE_HIDDEN(__init_array_end = . );"/>

            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="PROVIDE_HIDDEN(__fini_array_start = . );"/>
            <FileMapping Name="KEEP(*(SORT(.fini_array)))"/>
            <FileMapping Name="KEEP(*(.fini_array))"/>
            <FileMapping Name="PROVIDE_HIDDEN(__fini_array_end = . );"/>
            
            <!-- .ctors -->
            <!--<FileMapping Name="*crtbegin.o(.ctors)"/>-->
            <!--<FileMapping Name="*crtbegin?.o(.ctors)"/>-->
            <!--<FileMapping Name="*(EXCLUDE_FILE(*crtend?.o *crtend.o) .ctors)"/>-->
            <!--<FileMapping Name="*(SORT(.ctors.*))"/>-->
            <!--<FileMapping Name="*(.ctors)"/>-->
            
            <!-- .dtors -->
            <!--<FileMapping Name="*crtbegin.o(.dtors)"/>-->
            <!--<FileMapping Name="*crtbegin?.o(.dtors)"/>-->
            <!--<FileMapping Name="*(EXCLUDE_FILE(*crtend?.o *crtend.o) .dtors)"/>-->
            <!--<FileMapping Name="*(SORT(.dtors.*))"/>-->
            <!--<FileMapping Name="*(.dtors)"/>-->
            
            <FileMapping Name="*(.text .text.*)"/>
            <FileMapping Name="*(i.*)"/>
            <FileMapping Name="*(.rodata .rodata.* .constdata .constdata.* .conststring .conststring*)"/>
            <!--<FileMapping Name="*(rodata)"/>-->
            <!--<FileMapping Name="*(.constdata*)"/>-->
            <!--<FileMapping Name="*(.conststring*)"/>-->

            <FileMapping Name="*(vtable)"/>
            <FileMapping Name="*(.glue*)"/>
            <FileMapping Name="*(tinyclr_metadata)" />            
            
            <FileMapping Name="KEEP(*(.eh_frame*))"/>
            
            <FileMapping Name="*" Options="(tinyclr_metadata)" />
            
            <Include File="%SPOCLIENT%\Solutions\STM32F4DISCOVERY\scatterfile_gcc_missing_symbols.xml"/>
        </ExecRegion>
        
        <ExecRegion Name=".ARM.extab" Options="&gt;LR_%TARGETLOCATION% ">
            <FileMapping Name="*(.ARM.extab* .gnu.linkonce.armextab.*)"/>
        </ExecRegion>  
 
        <FileMapping Name=". = ALIGN(4);"/>
        <GlobalVariable Name="__exidx_start" Value="."/>

        <ExecRegion Name=".ARM.exidx" ALIGN="4" Options="&gt;LR_%TARGETLOCATION% ">
            <FileMapping Name="*(.ARM.exidx* .gnu.linkonce.armexidx.*)"/>
        </ExecRegion> 
        
        <GlobalVariable Name="__exidx_end" Value="."/>       

        <!-- ========= INTERNAL RAM ============================================= -->
        <!-- Writeable Vector table -->
        <!-- NOTE:
             Despite what you might hope for, this CANNOT go into the CCM area as the NVIC does not
             have access to that space (it sees the AHB layer and below, rather than the core's D-Bus)
        -->
        <!-- Alignment for the vector table is important to allow the NVIC to decode the proper locations
            (See Section 4.4.4 of the ARM Cortex-M4 Generic User Guide [ ARM DUI 0553A (ID121610) ] )
            Since this starts the SRAM block, it's aligned just fine for any size table.
        -->
        <ExecRegion Name="ER_VECTORS" Options="&gt;IRAM">
            <FileMapping Name="*" Options="(VectorTable)" />
        </ExecRegion>

        <FileMapping Name=". = ALIGN(4);"/>
        <GlobalVariable Name="_etext" Value="."/>
        <GlobalVariable Name="__etext" Value="."/>
        <GlobalVariable Name="_sidata" Value="LOADADDR(ER_RAM_RW)"/>

        <ExecRegion Name="ER_RAM_RW" Align="4" Base="ADDR(ER_VECTORS) + SIZEOF(ER_VECTORS)" Options="&gt;IRAM AT&gt;LR_FLASH ">
            <FileMapping Name="_sdata = .;"/>
            <FileMapping Name="__data_start__ = .;"/>

            <FileMapping Name="*(.data_begin .data_begin.*)"/>

            <!-- region ER_LWIP_OS_RW -->
            <!--<FileMapping Name=". = ALIGN(4);"/>-->
            <FileMapping Name="Image$$ER_LWIP_OS$$RW$$Base = .;"/>
            <!--<FileMapping Name="lwip_1_4_1_os_CMSIS_RTOS.lib (rwdata)" />-->
            <!--<FileMapping Name="sockets_hal_sockets_lwIP_os.lib (rwdata)" />-->
            <!--<FileMapping Name="sockets_hal_dhcp_lwIP_os.lib (rwdata)" />-->
            <!--<FileMapping Name="sockets_hal_tcp_lwIP_os.lib (rwdata)" />-->
            <!--<FileMapping Name="sockets_hal_udp_lwIP_os.lib (rwdata)" />-->
            <!--<FileMapping Name="lwip_1_4_1_os_CMSIS_RTOS.lib (.data)" />-->
            <!--<FileMapping Name="sockets_hal_sockets_lwIP_os.lib (.data)" />-->
            <!--<FileMapping Name="sockets_hal_dhcp_lwIP_os.lib (.data)" />-->
            <!--<FileMapping Name="sockets_hal_tcp_lwIP_os.lib (.data)" />-->
            <!--<FileMapping Name="sockets_hal_udp_lwIP_os.lib (.data)" />-->
            <FileMapping Name=". = ALIGN(4);"/>            
            <FileMapping Name="Image$$ER_LWIP_OS$$RW$$End = .;"/>
            <GlobalVariable Name="Image$$ER_LWIP_OS$$RW$$Length" Value="Image$$ER_LWIP_OS$$RW$$End - Image$$ER_LWIP_OS$$RW$$Base"/>

            <!--remove??-->   
            <FileMapping Name=". = ALIGN(4);"/>     
            <FileMapping Name="*(rwdata)"/>
            <FileMapping Name="*(.data .data.*)"/>

            <FileMapping Name="*(.data_end .data_end.*)"/>

            <FileMapping Name=". = ALIGN(4);"/>
            <!-- All data end -->
            <FileMapping Name="_edata = .;"/>
            <FileMapping Name="__data_end__ = .;"/>
        </ExecRegion>

        <ExecRegion Name=".bss (NOLOAD)" Align="4" Options="&gt;IRAM">
            <!--<FileMapping Name=". = ALIGN(4);"/>-->
            
            <FileMapping Name="__bss_start__ = .;"/>
            <FileMapping Name="_sbss = .;"/>
            <FileMapping Name="*(.bss_begin .bss_begin.*)" />
        
            <!-- region ER_LWIP_OS_ZI -->
            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="Image$$ER_LWIP_OS$$ZI$$Base = .;"/>
            <!--<FileMapping Name="lwip_1_4_1_os_CMSIS_RTOS.lib (.bss)" />-->
            <!--<FileMapping Name="sockets_hal_sockets_lwIP_os.lib (.bss)" />-->
            <!--<FileMapping Name="sockets_hal_dhcp_lwIP_os.lib (.bss)" />-->
            <!--<FileMapping Name="sockets_hal_tcp_lwIP_os.lib (.bss)" />-->
            <!--<FileMapping Name="sockets_hal_udp_lwIP_os.lib (.bss)" />-->
            <!--<FileMapping Name="lwip_1_4_1_os_CMSIS_RTOS.lib (.zidata)" />-->
            <!--<FileMapping Name="sockets_hal_sockets_lwIP_os.lib (.zidata)" />-->
            <!--<FileMapping Name="sockets_hal_dhcp_lwIP_os.lib (.zidata)" />-->
            <!--<FileMapping Name="sockets_hal_tcp_lwIP_os.lib (.zidata)" />-->
            <!--<FileMapping Name="sockets_hal_udp_lwIP_os.lib (.zidata)" />-->
            <!--<FileMapping Name="lwip_1_4_1_os_CMSIS_RTOS.lib (COMMON)" />-->-->
            <!--<FileMapping Name="sockets_hal_sockets_lwIP_os.lib (COMMON)" />-->
            <!--<FileMapping Name="sockets_hal_dhcp_lwIP_os.lib (COMMON)" />-->
            <!--<FileMapping Name="sockets_hal_tcp_lwIP_os.lib (COMMON)" />-->
            <!--<FileMapping Name="sockets_hal_udp_lwIP_os.lib (COMMON)" />-->
            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="Image$$ER_LWIP_OS$$ZI$$End = .;"/>
            <GlobalVariable Name="Image$$ER_LWIP_OS$$ZI$$Length" Value="Image$$ER_LWIP_OS$$ZI$$End - Image$$ER_LWIP_OS$$ZI$$Base"/>
                         
            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="*(.bss .bss.*)" />
            <FileMapping Name="*(.zidata)" />
            <FileMapping Name="*(g_SSL_SeedData)" />
            <FileMapping Name="*(COMMON)" />
            
            <FileMapping Name="*(.bss_end .bss_end.*)" />
            
            <FileMapping Name=". = ALIGN(4);"/>
            <FileMapping Name="__bss_end__ = .;"/>
            <FileMapping Name="_ebss = .;"/>  
            <FileMapping Name="_end_noinit = .;"/>   
        </ExecRegion>

        <!-- To enable re-initialization of the LWIP stack, which has no built-in support
             for re-init, all RW and ZI data for the stack is placed into an isolated region
             and the HAL soft reboot code handles re-initializing the data in this region.
        -->

        <ExecRegion Name="ER_RAM_RO" Align="4" Options="&gt;IRAM AT&gt;LR_FLASH">
            <!-- Flash programming from Flash is safe on STM32 -->
            <!-- No need to place Flash programming code in RAM -->
            <!-- <FileMapping Name="*" Options="(SectionForFlashOperations)" /> -->
        </ExecRegion>

        <FileMapping Name="PROVIDE ( end = _end_noinit );"/> <!-- was _ebss -->
        <FileMapping Name="PROVIDE ( _end = _end_noinit );"/> 
        <FileMapping Name="PROVIDE ( __end = _end_noinit );"/> 
        <FileMapping Name="PROVIDE ( __end__ = _end_noinit );"/> 

        <ExecRegion Name="ER_HEAP_BEGIN (NOLOAD)" Options="&gt;IRAM">
            <!--<FileMapping Name="_Heap_Begin = __end__;"/>-->
            <FileMapping Name="*" Options="(SectionForHeapBegin)" />
        </ExecRegion>

        <!-- everything between heapbegin and heapend will be allocated for a heap -->

        <ExecRegion Name="ER_HEAP_END" Base="%IRAM_BaseAddress% + %IRAM_Size% - 8" Options="&gt;IRAM" >
            <FileMapping Name="*" Options="(SectionForHeapEnd)" />
            <!--<FileMapping Name="_HeapLimit = .;"/>-->
        </ExecRegion>

        <ExecRegion Name="ER_CUSTOM_HEAP_BEGIN" Base="%IRAM_BaseAddress% + %IRAM_Size% - 8" Options="&gt;IRAM" >
            <FileMapping Name="*" Options="(SectionForCustomHeapBegin)" />
        </ExecRegion>

        <!-- everything between heapbegin and heapend will be allocated for the unmanaged SimpleHeap -->

        <ExecRegion Name="ER_CUSTOM_HEAP_END" Base="%IRAM_BaseAddress% + %IRAM_Size% - 8" Options="&gt;IRAM" >
            <FileMapping Name="*" Options="(SectionForCustomHeapEnd)" />
        </ExecRegion>

        <ExecRegion Name="/DISCARD/">
            <!--<FileMapping Name="*(.ARM.exidx*)" />-->
            <!--<FileMapping Name="*(.ARM.extab*)" />-->
            <FileMapping Name="libc.a ( * )" />
            <FileMapping Name="libm.a ( * )" />
            <FileMapping Name="libgcc.a ( * )" />
        </ExecRegion>

        <!-- ========= Internal CCM ============================================ -->
        <!-- Stack allocation pools for the OS, Sizes are set in RTX_Conf_CM.c along with other OS configuration -->
        <ExecRegion Name="ER_RT_STACK" Options="&gt;D_CCM">
            <FileMapping Name="*(rtx_stack)" />
        </ExecRegion>

        <!-- The rest of the CCM is used as a general stack during startup. This can't overlap with the ER_RT_STACK
             region as the kernel will zero that out during initialization, which would overwrite the stack of the
             code running the initialization, causing an early FAULT. Size and alignment are critical here. The stack
             must be aligned on an 8 byte boundary AND the size of this region must not extend it past the end of the
             actual physical CCM space. The CRT startup code will initialize the region and, if the aligned size
             puts the end outside of physical memory it will generate an imprecise abort.
        -->
        <ExecRegion Name="ER_STACK_BOTTOM" Align="8" Options="&gt;D_CCM">
            <FileMapping Name="*(SectionForStackBottom)" />
        </ExecRegion>

        <!-- (-8) for the two 32bit values in the SectionForStack* sections, This keeps the region
             limit from exceeding the size of physical memory. -->
        <ExecRegion Name="ER_STACK_TOP" Base="%Stack_Bottom% + %Stack_Size% - SIZEOF(ER_RT_STACK) - 8" Options="&gt;D_CCM">
            <FileMapping Name="*(SectionForStackTop)" />
        </ExecRegion>

        <ExecRegion Name="ER_CONFIG" Options="&gt;LR_CONFIG">
            <FileMapping Name="*(SectionForConfig)" />
        </ExecRegion>
    </NamedGroup>

    <!-- The following variables are used to simulate the ones autogenerated by ARMCC -->
    <GlobalVariable Name="Load$$ER_%TARGETLOCATION%$$Base"          Value="LOADADDR(ER_%TARGETLOCATION%)"/>
    <GlobalVariable Name="Image$$ER_%TARGETLOCATION%$$Length"       Value="SIZEOF(ER_%TARGETLOCATION%)"/>
    <GlobalVariable Name="Image$$ER_RAM_RO$$Base"                   Value="ADDR(ER_RAM_RO)"/>
    <GlobalVariable Name="Image$$ER_RAM_RO$$Length"                 Value="SIZEOF(ER_RAM_RO)"/>
    <GlobalVariable Name="Load$$ER_RAM_RO$$Base"                    Value="LOADADDR(ER_RAM_RO)"/>
    <GlobalVariable Name="Image$$ER_RAM_RW$$Base"                   Value="ADDR(ER_RAM_RW)"/>
    <GlobalVariable Name="Image$$ER_RAM_RW$$Length"                 Value="SIZEOF(ER_RAM_RW)"/>
    <GlobalVariable Name="Load$$ER_RAM_RW$$Base"                    Value="LOADADDR(ER_RAM_RW)"/>
    <GlobalVariable Name="Image$$ER_RAM_RW$$ZI$$Base"               Value="ADDR(.bss)"/>
    <GlobalVariable Name="Image$$ER_RAM_RW$$ZI$$Length"             Value="SIZEOF(.bss)"/>
    <GlobalVariable Name="Load$$ER_LWIP_OS$$RW$$Base"               Value="__etext"/>
    <!--<GlobalVariable Name="Image$$ER_LWIP_OS$$RW$$Base"              Value="ADDR(ER_LWIP_OS_RW)" />-->
    <!--<GlobalVariable Name="Image$$ER_LWIP_OS$$RW$$Length"            Value="SIZEOF(ER_LWIP_OS_RW)"/>-->
    <!--<GlobalVariable Name="Image$$ER_LWIP_OS$$ZI$$Base"              Value="ADDR(ER_LWIP_OS_ZI)" />-->
    <!--<GlobalVariable Name="Image$$ER_LWIP_OS$$ZI$$Length"            Value="SIZEOF(ER_LWIP_OS_ZI)"/>-->
    <GlobalVariable Name="__use_no_semihosting_swi"                 Value="0"/>
</ScatterFile>
